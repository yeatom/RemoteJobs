<!--miniprogram/pages/resume-profile/index.wxml-->
<view class="page">
  <view class="header-section">
    <view class="title-row">
      <text class="page-title">{{ui.title}}</text>
    </view>
    <view class="tips-card">
      <image class="tips-icon" src="../../assets/icons/four-pointed-start.png" mode="aspectFit" />
      <text class="tips-text">{{ui.tips}}</text>
    </view>
  </view>

  <scroll-view     
    class="resume-content" 
    scroll-y="{{true}}"
    enhanced="true" 
    show-scrollbar="{{false}}"
  >
    <view class="resume-body">
      <!-- 基本信息 -->
      <view class="section-group">
        <view class="section-group-title">{{ui.personalInfo}}</view>
        <view class="card">
          <!-- 照片 -->
          <view class="list-item photo-item" bindtap="onEditPhoto">
            <view class="item-label">{{ui.photo}}</view>
            <view class="item-value">
              <block wx:if="{{photo}}">
                <image class="avatar-img" src="{{photo}}" mode="aspectFill"></image>
              </block>
              <block wx:else>
                <view class="avatar-placeholder"></view>
              </block>
              <view class="arrow-icon"></view>
            </view>
          </view>
          
          <!-- 姓名 -->
          <view class="list-item" bindtap="onEditBasicInfo">
            <view class="item-label">{{ui.name}}</view>
            <view class="item-value">
              <text class="{{name ? 'value-text' : 'placeholder-text'}}">{{name || ui.noData}}</text>
              <view class="arrow-icon"></view>
            </view>
          </view>
        </view>
      </view>

      <!-- 联系方式 -->
      <view class="section-group">
        <view class="section-group-title">{{ui.contactInfo}}</view>
        <view class="card">
          <view class="list-item" bindtap="onEditWechat">
            <view class="item-label">{{ui.wechat}}</view>
            <view class="item-value">
              <text class="{{wechat ? 'value-text' : 'placeholder-text'}}">{{wechat || ui.noData}}</text>
              <view class="arrow-icon"></view>
            </view>
          </view>
          
          <view class="list-item" bindtap="onEditEmail">
            <view class="item-label">{{ui.email}}</view>
            <view class="item-value">
              <text class="{{email ? 'value-text' : 'placeholder-text'}}">{{email || ui.noData}}</text>
              <view class="arrow-icon"></view>
            </view>
          </view>
          
          <view class="list-item" bindtap="onEditPhone">
            <view class="item-label">{{ui.phone}}</view>
            <view class="item-value">
              <text class="{{phone ? 'value-text' : 'placeholder-text'}}">{{phone || ui.noData}}</text>
              <view class="arrow-icon"></view>
            </view>
          </view>
        </view>
      </view>

      <!-- 毕业院校 -->
      <view class="section-group">
        <view class="section-header-row">
          <view class="section-group-title">{{ui.education}}</view>
          <view class="add-btn" bindtap="onAddEducation">
            <text class="add-btn-text">{{ui.addEducation}}</text>
          </view>
        </view>
        
        <view class="card education-card">
          <block wx:if="{{educations && educations.length > 0}}">
            <view class="education-item" wx:for="{{educations}}" wx:key="index" bindtap="onEditEducation" data-index="{{index}}">
              <view class="edu-info">
                <view class="edu-header">
                  <view class="edu-school">{{item.school || ui.noData}}</view>
                  <view class="edu-date" wx:if="{{item.startDate || item.endDate || item.graduationDate}}">
                    {{item.startDate || ''}} - {{item.endDate || item.graduationDate || ''}}
                  </view>
                </view>
                <view class="edu-details">
                  <text wx:if="{{item.degree}}">{{item.degree}}</text>
                  <text wx:if="{{item.degree && item.major}}"> · </text>
                  <text wx:if="{{item.major}}">{{item.major}}</text>
                </view>
              </view>
              <view class="arrow-icon"></view>
            </view>
          </block>
          <block wx:else>
            <view class="empty-state" bindtap="onAddEducation">
              <text class="empty-text">{{ui.noData}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- 工作经历 -->
      <view class="section-group">
        <view class="section-header-row">
          <view class="section-group-title">{{ui.workExperience}}</view>
          <view class="add-btn" bindtap="onAddWorkExperience">
            <text class="add-btn-text">{{ui.addWorkExperience}}</text>
          </view>
        </view>
        
        <view class="card education-card">
          <block wx:if="{{workExperiences && workExperiences.length > 0}}">
            <view class="education-item" wx:for="{{workExperiences}}" wx:key="index" bindtap="onEditWorkExperience" data-index="{{index}}">
              <view class="edu-info">
                <view class="edu-header">
                  <view class="edu-school">{{item.company || ui.noData}}</view>
                  <view class="edu-date" wx:if="{{item.startDate || item.endDate}}">
                    {{item.startDate || ''}} - {{item.endDate || ''}}
                  </view>
                </view>
                <view class="edu-details">
                  <text wx:if="{{item.jobTitle}}">{{item.jobTitle}}</text>
                </view>
                <view class="edu-details business-dir" wx:if="{{item.businessDirection}}">
                  <text>{{item.businessDirection}}</text>
                </view>
              </view>
              <view class="arrow-icon"></view>
            </view>
          </block>
          <block wx:else>
            <view class="empty-state" bindtap="onAddWorkExperience">
              <text class="empty-text">{{ui.noData}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- 证书 -->
      <view class="section-group">
        <view class="section-header-row">
          <view class="section-group-title">{{ui.skills}}</view>
          <view class="add-btn" bindtap="onAddSkill">
            <text class="add-btn-text">{{ui.addSkill}}</text>
          </view>
        </view>
        
        <view class="tags-wrapper">
          <block wx:if="{{skills && skills.length > 0}}">
            <view class="tag-item skill-tag" wx:for="{{skills}}" wx:key="index" bindtap="onEditSkill" data-index="{{index}}">
              <text class="tag-text">{{item}}</text>
              <view class="tag-del" catchtap="onDeleteSkill" data-index="{{index}}">×</view>
            </view>
          </block>
          <block wx:else>
            <view class="empty-tags" bindtap="onAddSkill">
              <text class="empty-text">{{ui.noData}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- 证书 -->
      <view class="section-group">
        <view class="section-header-row">
          <view class="section-group-title">{{ui.certificates}}</view>
          <view class="add-btn" bindtap="onAddCertificate">
            <text class="add-btn-text">{{ui.addCertificate}}</text>
          </view>
        </view>
        
        <view class="tags-wrapper">
          <block wx:if="{{certificates && certificates.length > 0}}">
            <view class="tag-item" wx:for="{{certificates}}" wx:key="index" bindtap="onEditCertificate" data-index="{{index}}">
              <text class="tag-text">{{item}}</text>
              <view class="tag-del" catchtap="onDeleteCertificate" data-index="{{index}}">×</view>
            </view>
          </block>
          <block wx:else>
            <view class="empty-tags" bindtap="onAddCertificate">
              <text class="empty-text">{{ui.noData}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- 对 AI 说的话 -->
      <view class="section-group">
        <view class="section-group-title">{{ui.aiMessageLabel}}</view>
        <view class="card">
          <view class="list-item" bindtap="onEditAiMessage">
            <view class="item-value ai-message-value">
              <text class="{{aiMessage ? 'value-text' : 'placeholder-text'}} ai-message-text">{{aiMessage || ui.aiMessageDefault}}</text>
              <view class="arrow-icon"></view>
            </view>
          </view>
        </view>
      </view>
      
      <view class="bottom-safe-area"></view>
    </view>
  </scroll-view>

  <!-- 工作经历编辑弹窗 (右侧弹出) -->
  <view class="drawer-mask {{showWorkDrawer ? 'drawer-mask-show' : ''}}" bindtap="closeWorkDrawer"></view>
  <view class="drawer {{showWorkDrawer ? 'drawer-show' : ''}}">
    <view class="drawer-header">
      <text class="drawer-title">{{editingWorkIndex === -1 ? ui.addWorkExperience : ui.workExperience}}</text>
      <view wx:if="{{editingWorkIndex !== -1}}" class="header-delete" bindtap="onDeleteWorkExperience">
        <text>{{ui.delete}}</text>
      </view>
    </view>
    
    <view class="drawer-content">
      <view class="form-item">
        <text class="form-label">{{ui.company}}</text>
        <input class="form-input" placeholder="{{ui.companyPlaceholder}}" value="{{workForm.company}}" bindinput="onWorkCompanyInput" />
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.jobTitle}}</text>
        <input class="form-input" placeholder="{{ui.jobTitlePlaceholder}}" value="{{workForm.jobTitle}}" bindinput="onWorkJobTitleInput" />
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.timePeriod}}</text>
        <view class="date-range-row">
          <view class="picker-value {{workForm.startDate ? '' : 'placeholder-text'}}" bindtap="openDatePicker" data-field="work_startDate">
            {{workForm.startDate || ui.startDate}}
          </view>
          <text class="date-sep">-</text>
          <view class="picker-value {{workForm.endDate ? '' : 'placeholder-text'}}" bindtap="openDatePicker" data-field="work_endDate">
            {{workForm.endDate || ui.endDate}}
          </view>
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.businessDirection}} <text class="optional-hint">({{ui.optional}})</text></text>
        <textarea 
          class="form-textarea" 
          placeholder="{{ui.businessDirectionPlaceholder}}" 
          value="{{workForm.businessDirection}}" 
          bindinput="onWorkBusinessDirectionInput"
          maxlength="200"
          auto-height
        />
      </view>
    </view>

    <view class="drawer-footer">
      <view class="btn-secondary" bindtap="closeWorkDrawer">
        <text>{{ui.cancel}}</text>
      </view>
      <view class="btn-primary" bindtap="onSaveWorkExperience">
        <text>{{ui.save}}</text>
      </view>
    </view>
  </view>

  <!-- 教育经历编辑弹窗 (右侧弹出) -->
  <view class="drawer-mask {{showEduDrawer ? 'drawer-mask-show' : ''}}" bindtap="closeEduDrawer"></view>
  <view class="drawer {{showEduDrawer ? 'drawer-show' : ''}}">
    <view class="drawer-header">
      <text class="drawer-title">{{editingEduIndex === -1 ? ui.addEducation : ui.education}}</text>
      <view wx:if="{{editingEduIndex !== -1}}" class="header-delete" bindtap="onDeleteEducation">
        <text>{{ui.delete}}</text>
      </view>
    </view>
    
    <view class="drawer-content">
      <view class="form-item">
        <text class="form-label">{{ui.education}}</text>
        <input class="form-input" placeholder="{{ui.schoolPlaceholder}}" value="{{eduForm.school}}" bindinput="onEduSchoolInput" />
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.degree}}</text>
        <view class="picker-value {{eduForm.degree ? '' : 'placeholder-text'}}" bindtap="openDegreePicker">
          {{eduForm.degree || ui.degreePlaceholder}}
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.major}}</text>
        <input class="form-input" placeholder="{{ui.majorPlaceholder}}" value="{{eduForm.major}}" bindinput="onEduMajorInput" />
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.timePeriod}}</text>
        <view class="date-range-row">
          <view class="picker-value {{eduForm.startDate ? '' : 'placeholder-text'}}" bindtap="openDatePicker" data-field="startDate">
            {{eduForm.startDate || ui.startDate}}
          </view>
          <text class="date-sep">-</text>
          <view class="picker-value {{eduForm.endDate ? '' : 'placeholder-text'}}" bindtap="openDatePicker" data-field="endDate">
            {{eduForm.endDate || ui.endDate}}
          </view>
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.description}} <text class="optional-hint">({{ui.optional}})</text></text>
        <textarea 
          class="form-textarea" 
          placeholder="{{ui.descriptionPlaceholder}}" 
          value="{{eduForm.description}}" 
          bindinput="onEduDescriptionInput"
          maxlength="500"
          auto-height
        />
      </view>
    </view>

    <view class="drawer-footer">
      <view class="btn-secondary" bindtap="closeEduDrawer">
        <text>{{ui.cancel}}</text>
      </view>
      <view class="btn-primary" bindtap="onSaveEducation">
        <text>{{ui.save}}</text>
      </view>
    </view>
  </view>

  <!-- 个人基本信息编辑弹窗 (右侧弹出) -->
  <view class="drawer-mask {{showBasicInfoDrawer ? 'drawer-mask-show' : ''}}" bindtap="closeBasicInfoDrawer"></view>
  <view class="drawer {{showBasicInfoDrawer ? 'drawer-show' : ''}}">
    <view class="drawer-header">
      <text class="drawer-title">{{ui.personalInfo}}</text>
    </view>
    
    <view class="drawer-content">
      <view class="form-item">
        <text class="form-label">{{ui.name}}</text>
        <input class="form-input" placeholder="{{ui.namePlaceholder}}" value="{{basicInfoForm.name}}" bindinput="onBasicNameInput" />
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.gender}}</text>
        <view class="picker-value {{basicInfoForm.gender ? '' : 'placeholder-text'}}" bindtap="openGenderPicker">
          {{basicInfoForm.gender || ui.genderPlaceholder}}
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.birthday}}</text>
        <view class="picker-value {{basicInfoForm.birthday ? '' : 'placeholder-text'}}" bindtap="openBirthdayPicker">
          {{basicInfoForm.birthday || ui.birthdayPlaceholder}}
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">{{ui.identity}}</text>
        <view class="picker-value {{basicInfoForm.identity ? '' : 'placeholder-text'}}" bindtap="openIdentityPicker">
          {{basicInfoForm.identity || ui.identityPlaceholder}}
        </view>
      </view>
    </view>

    <view class="drawer-footer">
      <view class="btn-secondary" bindtap="closeBasicInfoDrawer">
        <text>{{ui.cancel}}</text>
      </view>
      <view class="btn-primary" bindtap="onSaveBasicInfo">
        <text>{{ui.save}}</text>
      </view>
    </view>
  </view>

  <!-- 对 AI 说的话编辑弹窗 (底部弹出) -->
  <view class="picker-mask {{showAiMessageSheet ? 'picker-mask-show' : ''}}" bindtap="closeAiMessageSheet"></view>
  <view class="custom-picker ai-message-picker {{showAiMessageSheet ? 'custom-picker-show' : ''}}">
    <view class="custom-picker-header">
      <view class="custom-picker-cancel" bindtap="closeAiMessageSheet">{{ui.cancel}}</view>
      <text class="custom-picker-title">{{ui.aiMessageLabel}}</text>
      <view class="custom-picker-confirm" bindtap="onSaveAiMessageSheet">{{ui.save}}</view>
    </view>
    <view class="ai-message-input-content">
      <textarea 
        class="ai-message-textarea" 
        placeholder="{{ui.aiMessageDefault}}" 
        value="{{aiMessageForm}}" 
        bindinput="onAiMessageInput"
        maxlength="500"
        focus="{{showAiMessageSheet}}"
        disable-default-padding
      />
    </view>
  </view>

  <!-- 自定义性别选择器 (底部弹出) -->
  <view class="picker-mask {{showGenderPicker ? 'picker-mask-show' : ''}}" bindtap="closeGenderPicker"></view>
  <view class="custom-picker {{showGenderPicker ? 'custom-picker-show' : ''}}">
    <view class="custom-picker-header">
      <text class="custom-picker-title">{{ui.genderPlaceholder}}</text>
      <view class="custom-picker-close" bindtap="closeGenderPicker">×</view>
    </view>
    <scroll-view class="custom-picker-body" scroll-y>
      <view 
        wx:for="{{genderOptions}}" 
        wx:key="*this" 
        class="picker-option {{basicInfoForm.gender === item ? 'picker-option-active' : ''}}"
        bindtap="onSelectGender"
        data-value="{{item}}"
      >
        <text class="option-text">{{item}}</text>
        <view class="check-icon" wx:if="{{basicInfoForm.gender === item}}"></view>
      </view>
    </scroll-view>
  </view>

  <!-- 自定义身份选择器 (底部弹出) -->
  <view class="picker-mask {{showIdentityPicker ? 'picker-mask-show' : ''}}" bindtap="closeIdentityPicker"></view>
  <view class="custom-picker {{showIdentityPicker ? 'custom-picker-show' : ''}}">
    <view class="custom-picker-header">
      <text class="custom-picker-title">{{ui.identityPlaceholder}}</text>
      <view class="custom-picker-close" bindtap="closeIdentityPicker">×</view>
    </view>
    <scroll-view class="custom-picker-body" scroll-y>
      <view 
        wx:for="{{identityOptions}}" 
        wx:key="*this" 
        class="picker-option {{basicInfoForm.identity === item ? 'picker-option-active' : ''}}"
        bindtap="onSelectIdentity"
        data-value="{{item}}"
      >
        <text class="option-text">{{item}}</text>
        <view class="check-icon" wx:if="{{basicInfoForm.identity === item}}"></view>
      </view>
    </scroll-view>
  </view>

  <!-- 自定义年月选择器 (底部弹出) -->
  <view class="picker-mask {{showDatePicker ? 'picker-mask-show' : ''}}" bindtap="closeDatePicker"></view>
  <view class="custom-picker {{showDatePicker ? 'custom-picker-show' : ''}}">
    <view class="custom-picker-header">
      <view class="custom-picker-cancel" bindtap="closeDatePicker">{{ui.cancel}}</view>
      <text class="custom-picker-title">{{(currentDatePickingField === 'startDate' || currentDatePickingField === 'work_startDate') ? ui.startDate : ((currentDatePickingField === 'endDate' || currentDatePickingField === 'work_endDate') ? ui.endDate : ui.birthday)}}</text>
      <view class="header-right-btns">
        <view wx:if="{{currentDatePickingField === 'work_endDate' || currentDatePickingField === 'endDate'}}" class="btn-present" bindtap="onSetToPresent">{{ui.toPresent}}</view>
        <view class="custom-picker-confirm" bindtap="onConfirmDate">{{ui.save}}</view>
      </view>
    </view>
    <view class="picker-view-container">
      <picker-view 
        indicator-style="height: 100rpx;" 
        style="width: 100%; height: 450rpx;" 
        value="{{datePickerValue}}" 
        bindchange="onDatePickerChange"
      >
        <picker-view-column>
          <view wx:for="{{years}}" wx:key="*this" class="picker-column-item">{{item}}年</view>
        </picker-view-column>
        <picker-view-column>
          <view wx:for="{{months}}" wx:key="*this" class="picker-column-item">{{item}}月</view>
        </picker-view-column>
      </picker-view>
    </view>
  </view>
</view>

