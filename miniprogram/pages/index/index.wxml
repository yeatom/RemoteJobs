<!-- Remote jobs list page -->
<view class="page">
  <!-- Internal tabs for job list (公开 / 精选 / 收藏) -->
  <view class="jobs-tabs">
    <view class="tab-slider tab-slider-{{currentTab}}"></view>
    <view class="tab {{currentTab === 0 ? 'tab-active' : ''}}" data-idx="0" bindtap="onTabTap">公开</view>
    <view class="tab {{currentTab === 1 ? 'tab-active' : ''}}" data-idx="1" bindtap="onTabTap">精选</view>
    <view class="tab {{currentTab === 2 ? 'tab-active' : ''}}" data-idx="2" bindtap="onTabTap">收藏</view>
  </view>

  <!-- Swiper for animated tab switch; enable touch for swipe -->
  <swiper current="{{currentTab}}" class="jobs-swiper" indicator-dots="{{false}}" autoplay="{{false}}" circular="{{false}}" duration="300" easing-function="easeOutCubic" disable-touch="{{false}}" bindchange="onSwiperChange">
    <!-- 公开 tab -->
    <swiper-item>
      <view class="tab-content-wrapper">
        <view class="search-bar">
          <input
            class="search-input"
            type="text"
            placeholder="{{ui.searchPlaceholder}}"
            placeholder-class="search-placeholder"
            confirm-type="search"
            value="{{tabState[0].searchKeyword}}"
            bindinput="onSearchInput"
          />

          <view class="search-actions">
            <view class="search-pill" bindtap="toggleSaveMenu">
              <text class="search-pill-text">{{ui.saveMenuLabel}}</text>
              <view class="search-pill-triangle {{tabState[0].showSaveMenu ? 'search-pill-triangle-up' : ''}}" />
            </view>
            <view class="search-pill" bindtap="toggleDrawer">
              <text class="search-pill-text">{{ui.filterLabel}}</text>
              <view class="search-pill-triangle" />
            </view>
          </view>
        </view>

        <!-- Save Menu Dropdown -->
        <view wx:if="{{tabState[0].showSaveMenu}}" class="save-menu-mask save-menu-mask-open" bindtap="toggleSaveMenu"></view>
        <view wx:if="{{tabState[0].showSaveMenu}}" class="save-menu-dropdown">
          <view class="save-menu-option" bindtap="onSaveAllJobs">
            <text class="save-menu-option-text">{{ui.collectAllLabel}}</text>
          </view>
          <view class="save-menu-option" bindtap="onSaveSearchCondition">
            <text class="save-menu-option-text">{{ui.saveSearchLabel}}</text>
          </view>
          <view class="save-menu-option" bindtap="onRestoreSearchCondition">
            <text class="save-menu-option-text">{{ui.restoreSearchLabel}}</text>
          </view>
        </view>

        <view class="job-list-wrapper">
          <job-list
            jobs="{{jobsByTab[0] || []}}"
            loading="{{loading}}"
            has-more="{{hasMore}}"
            scroll-y="{{true}}"
            scroll-top="{{tabState[0] ? tabState[0].scrollTop : 0}}"
            lower-threshold="{{lowerThreshold}}"
            scroll-with-animation="{{true}}"
            enhanced="{{true}}"
            show-scrollbar="{{false}}"
            enable-back-to-top="{{false}}"
            enable-passive="{{true}}"

            enable-detail="{{true}}"
            detail-selector="#jobDetail"
            detail-collection-fallback="{{selectedCollection}}"

            bind:itemtap="onJobTap"
            bind:scrolltolower="onScrollLower"
            bind:scroll="onScroll"
            bind:touchstart="onTouchStart"
            bind:touchend="onTouchEnd"
          />
        </view>
      </view>
    </swiper-item>
    <!-- 精选 tab -->
    <swiper-item>
      <view class="tab-content-wrapper {{currentTab === 1 && !isFeaturedUnlocked ? 'featured-locked' : ''}}">
        <view class="search-bar">
          <input
            class="search-input"
            type="text"
            placeholder="{{ui.searchPlaceholder}}"
            placeholder-class="search-placeholder"
            confirm-type="search"
            value="{{tabState[1].searchKeyword}}"
            bindinput="onSearchInput"
          />

          <view class="search-actions">
            <view class="search-pill" bindtap="toggleSaveMenu">
              <text class="search-pill-text">{{ui.saveMenuLabel}}</text>
              <view class="search-pill-triangle {{tabState[1].showSaveMenu ? 'search-pill-triangle-up' : ''}}" />
            </view>
            <view class="search-pill" bindtap="toggleDrawer">
              <text class="search-pill-text">{{ui.filterLabel}}</text>
              <view class="search-pill-triangle" />
            </view>
          </view>
        </view>

        <!-- Save Menu Dropdown -->
        <view wx:if="{{tabState[1].showSaveMenu}}" class="save-menu-mask save-menu-mask-open" bindtap="toggleSaveMenu"></view>
        <view wx:if="{{tabState[1].showSaveMenu}}" class="save-menu-dropdown">
          <view class="save-menu-option" bindtap="onSaveAllJobs">
            <text class="save-menu-option-text">{{ui.collectAllLabel}}</text>
          </view>
          <view class="save-menu-option" bindtap="onSaveSearchCondition">
            <text class="save-menu-option-text">{{ui.saveSearchLabel}}</text>
          </view>
          <view class="save-menu-option" bindtap="onRestoreSearchCondition">
            <text class="save-menu-option-text">{{ui.restoreSearchLabel}}</text>
          </view>
        </view>

        <view class="job-list-wrapper featured-tab-wrapper">
          <job-list
            jobs="{{jobsByTab[1] || []}}"
            loading="{{loading}}"
            has-more="{{hasMore}}"
            scroll-y="{{featuredScrollEnabled}}"
            scroll-top="{{tabState[1].scrollTop}}"
            lower-threshold="{{lowerThreshold}}"
            scroll-with-animation="{{true}}"
            enhanced="{{true}}"
            show-scrollbar="{{false}}"
            enable-back-to-top="{{false}}"
            enable-passive="{{true}}"

            enable-detail="{{true}}"
            detail-selector="#jobDetail"
            detail-collection-fallback="{{selectedCollection}}"

            bind:itemtap="onJobTap"
            bind:scrolltolower="onScrollLower"
            bind:scroll="onScroll"
            bind:touchstart="onTouchStart"
            bind:touchend="onTouchEnd"
          />
        </view>
        <!-- Subscription overlay for 精选 tab when expired - covers search-bar + job-list -->
        <view wx:if="{{currentTab === 1 && !isFeaturedUnlocked}}" class="featured-overlay">
          <view class="featured-overlay-text" bindtap="onFeaturedSubscribeTap">订阅后查看精选岗位</view>
        </view>
      </view>
    </swiper-item>
    <!-- 收藏 tab -->
    <swiper-item>
      <view class="tab-content-wrapper">
        <view class="search-bar">
          <input
            class="search-input"
            type="text"
            placeholder="{{ui.searchPlaceholder}}"
            placeholder-class="search-placeholder"
            confirm-type="search"
            value="{{tabState[2].searchKeyword}}"
            bindinput="onSearchInput"
          />

          <view class="search-actions">
            <view class="search-pill" bindtap="toggleSaveMenu">
              <text class="search-pill-text">{{ui.saveMenuLabel}}</text>
              <view class="search-pill-triangle {{tabState[2].showSaveMenu ? 'search-pill-triangle-up' : ''}}" />
            </view>
            <view class="search-pill" bindtap="toggleDrawer">
              <text class="search-pill-text">{{ui.filterLabel}}</text>
              <view class="search-pill-triangle" />
            </view>
          </view>
        </view>

        <!-- Save Menu Dropdown -->
        <view wx:if="{{tabState[2].showSaveMenu}}" class="save-menu-mask save-menu-mask-open" bindtap="toggleSaveMenu"></view>
        <view wx:if="{{tabState[2].showSaveMenu}}" class="save-menu-dropdown">
          <view class="save-menu-option" bindtap="onSaveAllJobs">
            <text class="save-menu-option-text">{{ui.collectAllLabel}}</text>
          </view>
          <view class="save-menu-option" bindtap="onSaveSearchCondition">
            <text class="save-menu-option-text">{{ui.saveSearchLabel}}</text>
          </view>
          <view class="save-menu-option" bindtap="onRestoreSearchCondition">
            <text class="save-menu-option-text">{{ui.restoreSearchLabel}}</text>
          </view>
        </view>

        <view class="job-list-wrapper">
          <job-list
            jobs="{{jobsByTab[2] || []}}"
            loading="{{loading}}"
            has-more="{{hasMore}}"
            scroll-y="{{true}}"
            scroll-top="{{tabState[2].scrollTop}}"
            lower-threshold="{{lowerThreshold}}"
            scroll-with-animation="{{true}}"
            enhanced="{{true}}"
            show-scrollbar="{{false}}"
            enable-back-to-top="{{false}}"
            enable-passive="{{true}}"

            enable-detail="{{true}}"
            detail-selector="#jobDetail"
            detail-collection-fallback="{{selectedCollection}}"

            bind:itemtap="onJobTap"
            bind:scrolltolower="onScrollLower"
            bind:scroll="onScroll"
            bind:touchstart="onTouchStart"
            bind:touchend="onTouchEnd"
          />
          <!-- Empty state for favorites tab -->
          <view wx:if="{{currentTab === 2 && !loading && jobsByTab[2] && jobsByTab[2].length === 0}}" class="empty-favorites">
            <text class="empty-favorites-text">{{ui.emptyFavorites}}</text>
          </view>
        </view>
      </view>
    </swiper-item>
  </swiper>
  <!-- Drawer Component for each tab -->
  <drawer
    wx:if="{{currentTab === 0}}"
    show="{{tabState[0].showDrawer}}"
    value="{{tabState[0].drawerFilter}}"
    bind:close="toggleDrawer"
    bind:confirm="onDrawerConfirm"
    bind:reset="onDrawerReset"
    bind:openFavorites="openFavoritesSheet"
  />
  <drawer
    wx:if="{{currentTab === 1}}"
    show="{{tabState[1].showDrawer}}"
    value="{{tabState[1].drawerFilter}}"
    bind:close="toggleDrawer"
    bind:confirm="onDrawerConfirm"
    bind:reset="onDrawerReset"
    bind:openFavorites="openFavoritesSheet"
  />
  <drawer
    wx:if="{{currentTab === 2}}"
    show="{{tabState[2].showDrawer}}"
    value="{{tabState[2].drawerFilter}}"
    bind:close="toggleDrawer"
    bind:confirm="onDrawerConfirm"
    bind:reset="onDrawerReset"
    bind:openFavorites="openFavoritesSheet"
  />

  <!-- Job Detail Drawer Component -->
  <job-detail
    id="jobDetail"
    show="{{showJobDetail}}"
    job-data="{{selectedJobData}}"
    bind:close="closeJobDetail"
    bind:savechange="onJobSaveChange"
  />

  <!-- Restore Search Condition Bottom Sheet -->
  <block wx:if="{{showRestoreSheet}}">
    <view class="bottom-sheet-mask {{restoreSheetOpen ? 'bottom-sheet-mask-open' : ''}}" bindtap="closeRestoreSheet"></view>
    <view class="bottom-sheet restore-sheet {{restoreSheetOpen ? 'bottom-sheet-open' : ''}}">
      <!-- Header with buttons -->
      <view class="bottom-sheet-header restore-sheet-header">
        <view class="restore-sheet-header-left">
          <view wx:if="{{isRestoreEditing}}" class="restore-header-btn" bindtap="onClearAllRestoreConditions">
            <text class="restore-header-btn-text">{{ui.clearAllLabel}}</text>
          </view>
        </view>
        <view class="restore-sheet-header-right">
          <view class="restore-header-btn" bindtap="toggleRestoreEdit">
            <text class="restore-header-btn-text">{{isRestoreEditing ? ui.doneLabel : ui.editLabel}}</text>
          </view>
        </view>
      </view>
      
      <view class="bottom-sheet-content restore-sheet-content">
        <view wx:if="{{savedSearchConditions.length === 0}}" class="empty-restore">
          <text class="empty-restore-text">暂无保存的搜索条件</text>
        </view>
        <view wx:for="{{savedSearchConditions}}" wx:key="_id" wx:for-item="item" wx:for-index="idx" class="restore-item {{isRestoreEditing ? 'restore-item-editing' : ''}} {{item.deleting ? 'restore-item-deleting' : ''}} {{item.collapsing ? 'restore-item-collapsing' : ''}}" data-index="{{idx}}" bindtap="{{isRestoreEditing ? '' : 'onSelectRestoreCondition'}}">
          <view class="restore-item-content">
            <view class="restore-item-title">{{item.title}}</view>
            <view class="restore-item-desc">{{item.desc}}</view>
          </view>
          <view wx:if="{{isRestoreEditing}}" class="restore-item-delete" data-index="{{idx}}" catchtap="onDeleteRestoreCondition">
            <image class="restore-item-delete-icon" src="/assets/icons/del-btn.png" mode="aspectFit" />
          </view>
        </view>
      </view>
    </view>
  </block>

</view>
